<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>刮金豆 - 管理后台</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: #2d2d2d;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 80%; /* Wider for table */
            max-width: 1200px;
            text-align: center;
        }
        h2 {
            margin-top: 0;
            color: #FFD700;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #FFD700;
            color: #000;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #ffea00;
        }
        .hidden {
            display: none;
        }
        .status-box {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #333;
            border: 1px solid #555;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }
        .status-inactive {
            background: #ff0000;
            box-shadow: 0 0 5px #ff0000;
        }
        .switch-btn {
            background: #4CAF50;
            color: white;
        }
        .switch-btn.active {
            background: #f44336;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
        }
        
        /* Table Styles */
        .table-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background-color: #333;
            color: #FFD700;
        }
        tr:hover {
            background-color: #3a3a3a;
        }
        .login-container-width {
            width: 350px !important;
        }
        .copyable {
            cursor: pointer;
            color: #FFD700;
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .copyable:hover {
            color: #fff;
        }
        .copy-hint {
            font-size: 0.8rem;
            color: #888;
            margin-left: 5px;
            text-decoration: none;
        }
    </style>
</head>
<body>

    <div class="container login-container-width" id="loginPanel">
        <h2>管理员登录</h2>
        <input type="text" id="username" placeholder="用户名">
        <input type="password" id="password" placeholder="密码">
        <button onclick="login()">登录</button>
    </div>

    <div class="container hidden" id="adminPanel">
        <h2>控制面板</h2>
        <div class="status-box">
            <p>必出金豆开关状态:</p>
            <div style="font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span id="statusIndicator" class="status-indicator status-inactive"></span>
                <span id="statusText" style="font-weight: bold; color: #aaa;">未开启</span>
            </div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">开启后，下一张金色刮刮乐必出特等奖(1g金豆)，出奖后自动关闭。</p>
        </div>
        
        <button id="toggleBtn" class="switch-btn" onclick="toggleTrigger()">开启必出金豆</button>
        
        <div class="table-container">
            <h3 style="color: #FFD700; text-align: left; border-bottom: 2px solid #444; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                中奖发货记录
                <button onclick="loadClaims()" style="width: auto; padding: 5px 15px; margin: 0; font-size: 0.8rem;">刷新列表</button>
            </h3>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>中奖时间</th>
                        <th>中奖地址</th>
                        <th>领奖方式</th>
                        <th>收货人</th>
                        <th>联系电话</th>
                        <th>详细收货地址</th>
                        <th>BNB钱包地址</th>
                    </tr>
                </thead>
                <tbody id="claimsTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </div>

        <button onclick="logout()" style="background: #555; color: #fff; margin-top: 40px; width: 200px;">退出登录</button>
    </div>

    <div id="toast" class="toast">操作成功</div>

    <script>
        const API_URL = 'https://api.bnbgold.top/api/admin';
        let currentPass = '';

        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }

        async function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                if (res.ok) {
                    currentPass = pass; // Store for session (simple insecure way for demo)
                    document.getElementById('loginPanel').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    refreshStatus();
                    loadClaims(); // Load table data
                } else {
                    alert('登录失败: 用户名或密码错误');
                }
            } catch (e) {
                console.error(e);
                alert('连接服务器失败');
            }
        }

        function logout() {
            currentPass = '';
            location.reload();
        }

        async function refreshStatus() {
            try {
                const res = await fetch(`${API_URL}/status`, {
                    headers: { 'X-Admin-Pass': currentPass }
                });
                const data = await res.json();
                updateUI(data.nextGoldBeanTrigger);
            } catch (e) {
                console.error(e);
            }
        }

        function updateUI(isActive) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('toggleBtn');

            if (isActive) {
                indicator.className = 'status-indicator status-active';
                text.textContent = '已开启 (等待出奖)';
                text.style.color = '#00ff00';
                btn.textContent = '取消必出金豆';
                btn.className = 'switch-btn active';
            } else {
                indicator.className = 'status-indicator status-inactive';
                text.textContent = '未开启';
                text.style.color = '#aaa';
                btn.textContent = '开启必出金豆';
                btn.className = 'switch-btn';
            }
        }

        async function toggleTrigger() {
            const btn = document.getElementById('toggleBtn');
            const isCurrentlyActive = btn.classList.contains('active');
            const newState = !isCurrentlyActive;

            try {
                const res = await fetch(`${API_URL}/trigger-gold-bean`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Pass': currentPass
                    },
                    body: JSON.stringify({ enable: newState })
                });

                if (res.ok) {
                    const data = await res.json();
                    updateUI(data.nextGoldBeanTrigger);
                    showToast(newState ? '已开启必出金豆' : '已取消必出金豆');
                } else {
                    alert('操作失败');
                }
            } catch (e) {
                console.error(e);
                alert('网络错误');
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('已复制到剪贴板: ' + text.substring(0, 20) + (text.length > 20 ? '...' : ''));
            } catch (err) {
                // Fallback
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                showToast('已复制');
            }
        }

        async function loadClaims() {
            try {
                const res = await fetch(`${API_URL}/claims`, {
                    headers: { 'X-Admin-Pass': currentPass }
                });
                if (res.ok) {
                    const claims = await res.json();
                    const tbody = document.getElementById('claimsTableBody');
                    tbody.innerHTML = '';
                    
                    if (claims.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color: #888;">暂无记录</td></tr>';
                        return;
                    }

                    claims.forEach((claim, index) => {
                        const tr = document.createElement('tr');
                        
                        // Format helper
                        const formatAddr = (addr) => {
                            if (!addr || addr === '-') return '-';
                            const short = addr.length > 10 ? addr.substring(0,6) + '...' + addr.substring(addr.length-4) : addr;
                            return `<span class="copyable" onclick="copyToClipboard('${addr}')" title="点击复制完整内容: ${addr}">${short}</span>`;
                        };
                        
                        // Format long text helper (shipping address)
                        const formatText = (text) => {
                             if (!text || text === '-') return '-';
                             const short = text.length > 15 ? text.substring(0, 15) + '...' : text;
                             return `<span class="copyable" onclick="copyToClipboard('${text}')" title="点击复制完整内容: ${text}">${short}</span>`;
                        };

                        tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${claim.timestamp}</td>
                            <td>${formatAddr(claim.address)}</td>
                            <td>${claim.type}</td>
                            <td>${claim.name}</td>
                            <td>${claim.phone}</td>
                            <td style="max-width: 200px;">${formatText(claim.shippingAddress)}</td>
                            <td>${formatAddr(claim.bnbAddress)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                console.error('Error loading claims:', e);
            }
        }

        // Auto-refresh status every 5 seconds
        setInterval(() => {
            if (currentPass) {
                refreshStatus();
                // loadClaims(); // Optional: Auto refresh table too? Maybe too heavy. Let's keep manual or less frequent.
            }
        }, 5000);

    </script>
</body>
</html>
